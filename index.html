<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”å¯®å°– V18.6 éŠ€é«®å‹å–„ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        html, body { 
            height: 100dvh; margin: 0; padding: 0; overflow: hidden;
            background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; 
            touch-action: pan-x;
        }
        [v-cloak] { display: none; }
        #app { height: 100%; display: flex; flex-direction: column; }

        /* è¡¨æ ¼çµæ§‹ */
        .table-wrapper {
            flex: 1; overflow-x: auto; overflow-y: auto;
            display: flex; flex-direction: column; scroll-snap-type: x mandatory;
            background: white;
            scrollbar-width: thin;
        }
        
        .table-wrapper::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .milk-table { border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        .milk-table th, .milk-table td { 
            padding: 2px 4px; text-align: center; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9;
            white-space: nowrap; font-size: 13px; position: relative; box-sizing: border-box;
        }

        /* æ¬„å¯¬èˆ‡å‡çµ */
        .col-day { width: 29vw; min-width: 95px; scroll-snap-align: start; transition: background-color 0.3s; }
        .col-header { width: 110px; min-width: 110px; z-index: 50; }
        .milk-table td:first-child, .milk-table th:first-child {
            position: sticky; left: 0; z-index: 20; background: white; 
            border-right: 2px solid #e2e8f0; text-align: left; padding-left: 12px; 
            color: #64748b; font-weight: 700;
        }
        .milk-table thead th { position: sticky; top: 0; z-index: 30; border-bottom: 2px solid #e2e8f0; height: 65px; background: white; }
        .milk-table thead th:first-child { z-index: 40; }

        /* æ¨£å¼ */
        .is-today { background-color: #eff6ff !important; border-left: 2px solid #3b82f6; border-right: 2px solid #3b82f6; }
        .is-today-header { background-color: #dbeafe !important; border-top: 4px solid #2563eb !important; }

        .row-icon { width: 18px; text-align: center; display: inline-block; margin-right: 4px; opacity: 0.6; }
        .time-label { display: block; font-size: 10px; color: #94a3b8; font-weight: 500; margin-bottom: 0px; }
        .item-label { font-size: 12px; color: #334155; font-weight: 700; }
        
        /* æ•¸å­—å­—é«”èˆ‡å‹•æ…‹å¤§å° */
        .num-font { font-family: 'Roboto Mono', monospace; font-weight: 500; transition: font-size 0.2s; }
        
        .val-plus { color: #059669; background: #ecfdf5; padding: 2px 6px; border-radius: 6px; }
        .val-minus { color: #2563eb; }
        .val-prep { color: #dc2626; font-weight: 700; } 
        .val-balance { font-weight: 900; color: #1e293b; }
        .val-mid-balance { color: #64748b; font-weight: 700; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; }
        
        .val-override { text-decoration: underline; text-decoration-color: #fca5a5; text-decoration-thickness: 2px; color: #b91c1c; }

        /* æ¨¡æ“¬è¡Œæ¨£å¼ */
        .sim-row td { background-color: #f0f9ff; vertical-align: top; padding-top: 6px; }
        .sim-val { font-weight: bold; color: #0891b2; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .sim-off { text-decoration: line-through; opacity: 0.4; color: #94a3b8; }

        /* Badges */
        .tag-badge { display: inline-block; font-size: 10px; padding: 1px 6px; border-radius: 4px; margin-top: 2px; font-weight: bold; color: white; }
        .adhoc-badge { background-color: #a855f7; color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-top: 2px; display: inline-block; }
        .sim-badge { background-color: #0ea5e9; color: white; font-size: 9px; padding: 1px 6px; border-radius: 10px; font-weight: bold; margin-top: 2px; display: inline-block; line-height: 1.4; }

        /* Drawer & Sidebar */
        .drawer-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); z-index: 40; }
        .drawer-body { 
            position: fixed; bottom: 0; left: 0; right: 0; background: white; z-index: 50; 
            border-radius: 24px 24px 0 0; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .drawer-body.active { transform: translateY(0); }

        /* Sidebar (Right) */
        .sidebar {
            position: fixed; top: 0; right: 0; bottom: 0; width: 280px; background: white; z-index: 60;
            box-shadow: -5px 0 25px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.2); z-index: 55; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        .toast {
            position: fixed; top: 16px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #1e293b; color: white; padding: 10px 20px; border-radius: 30px;
            font-weight: 600; font-size: 13px; z-index: 100; transition: transform 0.3s; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; items-center; gap: 8px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Print Styles */
        @media print {
            body { height: auto; overflow: visible; background: white; }
            #app { height: auto; display: block; }
            .table-wrapper { overflow: visible; display: block; }
            header, .drawer-body, .drawer-mask, .sidebar, .sidebar-mask, .toast { display: none !important; }
            .col-day { width: auto; min-width: 60px; border: 1px solid #ddd; }
            .milk-table th, .milk-table td { border: 1px solid #ccc; font-size: 10px; }
            .milk-table { width: 100%; }
            /* Hide sticky behavior for print */
            .milk-table td:first-child, .milk-table th:first-child, .milk-table thead th { position: static; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<div id="app" v-cloak>

    <header class="bg-white px-4 py-2 border-b border-slate-100 flex-none z-30 flex justify-between items-center h-[55px]">
        <div>
            <div class="text-[10px] text-slate-400 font-bold uppercase">Today Balance</div>
            <div class="text-2xl font-black text-slate-800 num-font leading-none">
                {{ todayEndStock.toFixed(1) }} <span class="text-sm text-slate-300">L</span>
            </div>
        </div>
        <div class="flex gap-2">
            <button @click="showHistory = !showHistory" class="px-3 h-9 rounded-full text-xs font-bold flex items-center gap-1 border transition-colors"
                :class="showHistory ? 'bg-slate-100 text-slate-600 border-slate-200' : 'bg-blue-50 text-blue-600 border-blue-200'">
                <i class="fas" :class="showHistory ? 'fa-eye' : 'fa-eye-slash'"></i>
                {{ showHistory ? 'é¡¯ç¤ºå…¨éƒ¨' : 'åªçœ‹è¿‘æœŸ' }}
            </button>
            <button @click="sidebarOpen=true" class="w-9 h-9 bg-slate-50 rounded-full text-slate-500 flex items-center justify-center active:bg-slate-200">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <div v-if="sidebarOpen" class="sidebar-mask" @click="sidebarOpen=false"></div>
    <div class="sidebar" :class="{ 'open': sidebarOpen }">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center">
            <h2 class="font-bold text-lg text-slate-800">è¨­å®šé¸å–®</h2>
            <button @click="sidebarOpen=false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <div class="p-6 flex-1 overflow-y-auto">
            <div class="mb-8">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">æ•¸å­—å¤§å° (éŠ€é«®å‹å–„)</div>
                <div class="flex gap-2">
                    <button @click="fontLevel=1" :class="fontLevel===1 ? 'bg-blue-600 text-white ring-2 ring-blue-200' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl font-bold transition-all text-sm">æ¨™æº–</button>
                    <button @click="fontLevel=1.3" :class="fontLevel===1.3 ? 'bg-blue-600 text-white ring-2 ring-blue-200' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl font-bold transition-all text-base">å¤§</button>
                    <button @click="fontLevel=1.6" :class="fontLevel===1.6 ? 'bg-blue-600 text-white ring-2 ring-blue-200' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl font-bold transition-all text-lg">ç‰¹å¤§</button>
                </div>
                <div class="mt-2 text-center num-font bg-slate-50 py-2 rounded border border-slate-100 text-slate-600" :style="{ fontSize: (15 * fontLevel) + 'px' }">
                    é è¦½: 128.5 L
                </div>
            </div>

            <div class="mb-8">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">å ±è¡¨åˆ—å°</div>
                <button @click="printReport" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform">
                    <i class="fas fa-print"></i>
                    åˆ—å° (2/15 - 3/01)
                </button>
                <p class="text-[10px] text-slate-400 mt-2 text-center">é»æ“Šå¾Œå°‡è‡ªå‹•ç¯©é¸æ—¥æœŸä¸¦é–‹å•Ÿåˆ—å°è¦–çª—</p>
            </div>
        </div>
        
        <div class="p-4 bg-slate-50 text-center text-[10px] text-slate-400">
            System V18.6
        </div>
    </div>

    <div class="table-wrapper">
        <table class="milk-table">
            <thead>
                <tr>
                    <th class="col-header">
                        <div class="flex flex-col items-start justify-center h-full pl-1">
                            <span class="text-xs text-slate-400 font-bold">é …ç›® \ æ—¥æœŸ</span>
                        </div>
                    </th>
                    <th v-for="d in filteredDays" :key="d.key" class="col-day cursor-pointer" 
                        :class="[d.colorClass, {'bg-slate-50': !d.colorClass && d.isWeekend, 'is-today-header': d.isToday}]"
                        @click="openDateSettings(d)">
                        <div class="flex flex-col items-center justify-center">
                            <span class="text-sm font-black">{{ d.weekDay }}</span>
                            <span class="text-[10px] opacity-60 font-bold mb-0.5">{{ d.dateStr }}</span>
                            <div v-if="d.isToday" class="text-[9px] bg-blue-600 text-white px-1.5 rounded mb-0.5">TODAY</div>
                            <div v-if="d.taskLabel" class="tag-badge" :style="{ backgroundColor: d.badgeColor }">
                                {{ d.taskLabel }}
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <span class="time-label">07:00</span>
                        <i class="fas fa-cube row-icon text-slate-400"></i><span class="item-label">æœŸåˆåº«å­˜</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('inventory', d)" class="num-font text-slate-400 cursor-pointer" :style="{ fontSize: (15 * fontLevel) + 'px' }" :class="{'is-today': d.isToday}">
                        {{ d.startStock.toFixed(1) }}
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <span class="time-label">08:00</span>
                        <i class="fas fa-tint row-icon text-emerald-500"></i><span class="item-label">æ™¨é–“æ”¶ä¹³</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('harvestAM', d)" class="cursor-pointer" :class="{'is-today': d.isToday}">
                        <span class="num-font val-plus" :style="{ fontSize: (15 * fontLevel) + 'px' }">+{{ d.harvestAM }}</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span class="time-label">10:00</span>
                        <i class="fas fa-users row-icon text-blue-500"></i><span class="item-label">å®¶åº­å®…é…</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('deliveryHome', d)" class="cursor-pointer" :class="{'is-today': d.isToday}">
                        <span v-if="d.deliveryHome > 0" class="num-font val-minus" :style="{ fontSize: (15 * fontLevel) + 'px' }" :class="{'val-override': d.isHomeOverridden}">
                            -{{ d.deliveryHome.toFixed(1) }}
                        </span>
                        <span v-else class="text-slate-200">-</span>
                    </td>
                </tr>

                <tr class="bg-slate-50/50">
                    <td>
                        <span class="time-label">12:00</span>
                        <i class="fas fa-clipboard-check row-icon text-slate-500"></i><span class="item-label text-slate-600">åˆé–“ç›¤é»</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" class="text-center" :class="{'is-today': d.isToday}">
                        <span class="num-font val-mid-balance" :style="{ fontSize: (14 * fontLevel) + 'px' }">{{ d.noonStock.toFixed(1) }}</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span class="time-label">13:00</span>
                        <i class="fas fa-blender row-icon text-amber-500"></i><span class="item-label">åŠ å·¥/å¿«é–ƒ</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('process', d)" class="cursor-pointer" :class="{'is-today': d.isToday}">
                        <div v-if="d.process.vol > 0" class="text-amber-600 font-bold num-font" :style="{ fontSize: (12 * fontLevel) + 'px' }">
                             -{{ d.process.vol.toFixed(1) }}
                        </div>
                        <div v-if="d.flash.vol > 0" class="text-pink-500 font-bold num-font" :style="{ fontSize: (12 * fontLevel) + 'px' }">-{{ d.flash.vol }}</div>
                        <span v-if="d.process.vol===0 && d.flash.vol===0" class="text-slate-200">-</span>
                    </td>
                </tr>
                 <tr>
                    <td>
                        <span class="time-label">15:00</span>
                        <i class="fas fa-plus-circle row-icon text-purple-500"></i><span class="item-label">è‡¨æ™‚/åœ˜è³¼</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('adhoc', d)" class="cursor-pointer" :class="{'is-today': d.isToday}">
                        <div v-if="d.adhoc.active && (d.adhoc.total > 0 || d.group.vol > 0)">
                             <div class="font-bold text-purple-600 mb-1 num-font" :style="{ fontSize: (12 * fontLevel) + 'px' }">-{{ (d.adhoc.total + d.group.vol).toFixed(1) }}</div>
                             <div v-if="d.adhoc.desc" class="adhoc-badge">
                                 {{ d.adhoc.desc }}
                             </div>
                        </div>
                        <span v-else class="text-slate-200">-</span>
                    </td>
                </tr>

                <tr v-for="(simName, idx) in ['èª¿æ§ A', 'èª¿æ§ B']" :key="'sim'+idx" class="sim-row" style="height: 60px;">
                    <td>
                        <span class="time-label" v-if="idx===0">é æ¸¬èª¿ç¯€</span>
                        <i class="fas fa-sliders-h row-icon text-cyan-600"></i><span class="item-label text-cyan-700">{{ simName }}</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('sim', d, idx)" class="cursor-pointer" :class="{'is-today': d.isToday}">
                        <div v-if="d.sims[idx] && d.sims[idx].val > 0" class="sim-val flex-col" :class="{'sim-off': !d.sims[idx].active}">
                            <div class="num-font" :style="{ fontSize: (11 * fontLevel) + 'px' }">
                                <span v-if="d.sims[idx].active">-</span>{{ d.sims[idx].val }}
                                <i v-if="!d.sims[idx].active" class="fas fa-ban text-[8px]"></i>
                            </div>
                            <div v-if="d.sims[idx].desc" class="sim-badge">
                                {{ d.sims[idx].desc }}
                            </div>
                        </div>
                        <span v-else class="text-slate-200 text-[10px]">-</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span class="time-label">19:00</span>
                        <i class="fas fa-box-open row-icon text-red-500"></i><span class="item-label">éš”æ—¥æ™¨é…</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('routePrep', d)" class="cursor-pointer bg-red-50/30" :class="{'is-today': d.isToday}">
                        <div v-if="d.routePrep > 0">
                            <span class="num-font val-prep" :style="{ fontSize: (15 * fontLevel) + 'px' }">-{{ d.routePrep.toFixed(1) }}</span>
                            <div v-if="d.weekDay === 'äº”'" class="text-[9px] text-red-400 font-normal transform scale-90 origin-center mt-0.5">
                                å…­:{{ d.nextDayRoute }} + æ—¥:{{ d.afterNextRoute }}
                            </div>
                        </div>
                        <span v-else class="text-slate-200">-</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span class="time-label">20:00</span>
                        <i class="fas fa-moon row-icon text-indigo-500"></i><span class="item-label">æ™šé–“æ”¶ä¹³</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" @click="edit('harvestPM', d)" class="cursor-pointer" :class="{'is-today': d.isToday}">
                        <span class="num-font val-plus" :style="{ fontSize: (15 * fontLevel) + 'px' }">+{{ d.harvestPM }}</span>
                    </td>
                </tr>

                <tr style="height: 120px;">
                    <td style="background-color: #f8fafc;">
                        <span class="time-label">22:00</span>
                        <i class="fas fa-flag row-icon text-slate-800"></i><span class="item-label">æœ¬æ—¥çµé¤˜</span>
                    </td>
                    <td v-for="d in filteredDays" :key="d.key" class="align-top pt-2" :class="{'is-today': d.isToday}">
                        <div class="num-font val-balance leading-none mb-2 border-b border-slate-200 pb-1" :style="{ fontSize: (20 * fontLevel) + 'px' }">{{ d.endStock.toFixed(1) }}</div>
                        <div class="flex flex-col gap-1 text-[11px] font-bold text-slate-500 items-center">
                            <div v-if="d.buckets.b23 > 0" class="text-slate-600 bg-slate-100 px-2 py-0.5 rounded-md w-full max-w-[80px]">
                                ğŸ± x {{ d.buckets.b23 }}
                            </div>
                            <div v-if="d.buckets.b30 > 0" class="text-slate-600 bg-slate-100 px-2 py-0.5 rounded-md w-full max-w-[80px]">
                                ğŸ“¦ x {{ d.buckets.b30 }}
                            </div>
                            <div v-if="d.buckets.left > 0" class="text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md w-full max-w-[80px]">
                                ğŸ’§ {{ d.buckets.left.toFixed(1) }}
                            </div>
                             <div class="mt-1 text-slate-800 border-t border-slate-300 w-full pt-1">
                                åˆè¨ˆ <span class="num-font text-slate-900" :style="{ fontSize: (18 * fontLevel) + 'px' }">{{ d.buckets.total }}</span> æ¡¶
                            </div>
                        </div>
                    </td>
                </tr>

                <tr style="height: 45px; background: #f8fafc;">
                    <td class="text-xs text-slate-400 pl-3">ç¸½ç“¶æ•¸åƒè€ƒ</td>
                    <td v-for="d in filteredDays" :key="d.key" class="text-[10px] text-center text-slate-500" :class="{'is-today': d.isToday}">
                        <div v-if="d.bottleInfo.big>0 || d.bottleInfo.small>0">
                            å¤§:{{d.bottleInfo.big}} å°:{{d.bottleInfo.small}}
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div v-if="drawer.show" class="drawer-mask" @click="drawer.show=false"></div>
    <div class="drawer-body" :class="{ 'active': drawer.show }">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4"></div>
        
        <div v-if="drawer.mode === 'settings'" class="px-6 pb-8">
            <h3 class="text-xl font-bold text-slate-800 mb-4">{{ drawer.dateLabel }} è¨­å®š</h3>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 mb-2 block">é«˜å…‰æ¨™è¨˜é¡è‰²</label>
                <div class="flex justify-between gap-2">
                    <button v-for="c in colorOptions" :key="c.val" @click="setDateColor(c.val)" 
                        class="h-12 flex-1 rounded-xl border-2 transition-all"
                        :class="[c.bg, c.border, drawer.val === c.val ? 'ring-2 ring-slate-400 scale-105' : 'opacity-70']">
                    </button>
                    <button @click="setDateColor('')" class="h-12 w-12 rounded-xl border-2 border-slate-200 flex items-center justify-center text-slate-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-slate-400 mb-2 block">ä¸»è¦ä»»å‹™æ¨™ç±¤</label>
                <div class="grid grid-cols-3 gap-3">
                    <button v-for="t in taskOptions" :key="t" @click="setDateTask(t)" 
                        class="py-3 rounded-xl border font-bold text-sm transition-colors"
                        :class="drawer.text === t ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200'">
                        {{ t }}
                    </button>
                </div>
                <input v-model="drawer.text" type="text" placeholder="è‡ªè¨‚æ¨™ç±¤..." class="mt-3 w-full p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm">
            </div>
             <button @click="saveDateSettings" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold">å„²å­˜è¨­å®š</button>
        </div>

        <div v-else class="px-6 pb-6">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h3 class="text-2xl font-black text-slate-800">{{ drawer.title }}</h3>
                    <p class="text-sm text-slate-400 font-bold mt-1">{{ drawer.dateLabel }}</p>
                </div>
                <button @click="save" class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-slate-200 active:scale-95 transition">ç¢ºèª</button>
            </div>

            <div class="space-y-6">
                <div v-if="['inventory','harvestAM','harvestPM','routePrep','flash'].includes(drawer.type)" class="flex flex-col gap-4">
                     <div class="flex items-center gap-4">
                        <button @click="adj(-1)" class="w-16 h-16 bg-slate-100 rounded-2xl text-2xl font-bold text-slate-600 active:bg-slate-200">-</button>
                        <div class="flex-1">
                            <input v-model.number="drawer.val" type="number" step="0.1" class="w-full text-center text-6xl font-black text-slate-800 focus:outline-none bg-transparent">
                            <div class="text-center text-xs text-slate-400 font-bold tracking-widest mt-1">LITERS</div>
                        </div>
                        <button @click="adj(1)" class="w-16 h-16 bg-slate-100 rounded-2xl text-2xl font-bold text-slate-600 active:bg-slate-200">+</button>
                    </div>
                    <button @click="drawer.val = 0" class="w-full py-2 bg-slate-100 text-slate-400 text-xs font-bold rounded-lg hover:bg-red-50 hover:text-red-500 transition">
                        <i class="fas fa-undo mr-1"></i> æ­¸é›¶é‡ç½®
                    </button>
                </div>

                <div v-if="drawer.type === 'routePrep' && drawer.isFriday" class="bg-red-50 p-4 rounded-xl flex justify-around text-center">
                    <div>
                        <div class="text-xs text-red-400 mb-1">é€±å…­ç”¨é‡</div>
                        <div class="text-xl font-black text-red-600">{{ drawer.nextRoute }}</div>
                        <button @click="drawer.val = drawer.nextRoute" class="text-[10px] bg-white border px-2 py-1 rounded mt-1">å¸¶å…¥</button>
                    </div>
                    <div class="text-red-300 text-2xl font-light">+</div>
                    <div>
                        <div class="text-xs text-red-400 mb-1">é€±æ—¥ç”¨é‡</div>
                        <div class="text-xl font-black text-red-600">{{ drawer.afterNextRoute }}</div>
                         <button @click="drawer.val = drawer.afterNextRoute" class="text-[10px] bg-white border px-2 py-1 rounded mt-1">å¸¶å…¥</button>
                    </div>
                    <div class="border-l pl-4 flex items-center">
                         <button @click="drawer.val = drawer.nextRoute + drawer.afterNextRoute" class="bg-red-500 text-white px-3 py-2 rounded-lg text-xs font-bold">å¸¶å…¥åˆè¨ˆ</button>
                    </div>
                </div>
                
                <div v-if="drawer.type === 'process'" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <button @click="drawer.pSmall++" class="bg-amber-50 p-6 rounded-3xl active:bg-amber-100"><span class="block text-sm font-bold text-amber-800">å° (3.7L)</span><span class="block text-4xl font-black text-amber-600">{{ drawer.pSmall }}</span></button>
                        <button @click="drawer.pBig++" class="bg-orange-50 p-6 rounded-3xl active:bg-orange-100"><span class="block text-sm font-bold text-orange-800">å¤§ (1.3L)</span><span class="block text-4xl font-black text-orange-600">{{ drawer.pBig }}</span></button>
                        <div class="col-span-2 flex justify-center gap-4 text-sm text-slate-400 font-bold">
                            <span v-if="drawer.pSmall>0" @click="drawer.pSmall--" class="cursor-pointer hover:text-red-500"><i class="fas fa-minus"></i> æ¸›å°‘å°</span>
                            <span v-if="drawer.pBig>0" @click="drawer.pBig--" class="cursor-pointer hover:text-red-500"><i class="fas fa-minus"></i> æ¸›å°‘å¤§</span>
                        </div>
                    </div>
                    <div class="text-center text-xl font-bold">åˆè¨ˆ: {{ ((drawer.pSmall*3.7)+(drawer.pBig*1.3)).toFixed(1) }} L</div>
                    <button @click="drawer.pSmall=0;drawer.pBig=0" class="w-full py-2 bg-slate-100 text-slate-400 text-xs font-bold rounded-lg hover:bg-red-50 hover:text-red-500 transition">æ­¸é›¶é‡ç½®</button>
                </div>

                <div v-if="drawer.type === 'deliveryHome'" class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-xl flex justify-between items-center">
                        <span class="text-blue-800 font-bold text-sm">CSV å»ºè­°å€¼ (åƒè€ƒ)</span>
                        <span class="text-2xl font-black text-blue-600">{{ drawer.csvVal.toFixed(1) }}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="text-xs text-slate-400 font-bold block mb-2">å¼·åˆ¶è¨­å®šç¸½å‡ºè²¨é‡</label>
                            <input v-model.number="drawer.val" type="number" step="0.1" class="w-full bg-slate-100 p-4 rounded-xl text-3xl font-black text-center focus:ring-2 ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="drawer.val = drawer.csvVal" class="flex-1 py-3 bg-blue-100 text-blue-700 font-bold rounded-xl text-sm">å¸¶å…¥å»ºè­°å€¼</button>
                        <button @click="drawer.val = null" class="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl text-sm">æ¸…é™¤å¼·åˆ¶è¨­å®š</button>
                    </div>
                    
                    <div class="mt-4 border-t pt-4">
                         <h4 class="text-xs font-bold text-slate-400 mb-2">æ˜ç´°åƒè€ƒ</h4>
                         <div class="max-h-[20vh] overflow-y-auto space-y-1">
                             <div v-for="(item, idx) in drawer.list" :key="idx" class="flex justify-between text-sm py-1 border-b border-slate-50">
                                 <span class="text-slate-600">{{ item.name }}</span>
                                 <span class="font-mono text-slate-400">{{ item.big }}å¤§ {{ item.small }}å°</span>
                             </div>
                             <div v-if="drawer.list.length===0" class="text-center text-slate-300 text-sm py-2">ç„¡è³‡æ–™</div>
                         </div>
                    </div>
                </div>

                <div v-if="drawer.type === 'adhoc'" class="space-y-4">
                      <div class="flex items-center justify-between bg-purple-50 p-4 rounded-2xl">
                        <span class="font-bold text-purple-800">å•Ÿç”¨æ­¤ç­†èª¿ç¯€</span>
                        <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                            <input v-model="drawer.adActive" type="checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                            <label class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1 bg-purple-50 p-4 rounded-2xl text-center"><span class="text-xs text-purple-800">å¤§ (0.95)</span><div class="flex justify-center gap-2 mt-2"><button @click="drawer.adBig--" class="text-purple-400">-</button><span class="text-2xl font-black text-purple-800">{{drawer.adBig}}</span><button @click="drawer.adBig++" class="text-purple-400">+</button></div></div>
                         <div class="flex-1 bg-purple-50 p-4 rounded-2xl text-center"><span class="text-xs text-purple-800">å° (0.5)</span><div class="flex justify-center gap-2 mt-2"><button @click="drawer.adSmall--" class="text-purple-400">-</button><span class="text-2xl font-black text-purple-800">{{drawer.adSmall}}</span><button @click="drawer.adSmall++" class="text-purple-400">+</button></div></div>
                    </div>
                    <input v-model="drawer.adDesc" type="text" placeholder="è¼¸å…¥åç¨± (ä¾‹: åœ˜è³¼/è©¦å–)" class="w-full bg-slate-50 p-3 rounded-xl font-bold border border-slate-200">
                    <input v-model.number="drawer.adCustom" type="number" placeholder="å…¶ä»–æ•¸é‡ (L)" class="w-full bg-slate-50 p-3 rounded-xl font-bold">
                    <button @click="drawer.adBig=0;drawer.adSmall=0;drawer.adCustom=0" class="w-full py-2 bg-slate-100 text-slate-400 text-xs font-bold rounded-lg hover:bg-red-50 hover:text-red-500 transition">æ­¸é›¶é‡ç½®</button>
                 </div>

                 <div v-if="drawer.type === 'sim'" class="space-y-6">
                    <div class="flex items-center justify-between bg-cyan-50 p-4 rounded-2xl">
                        <span class="font-bold text-cyan-800">å•Ÿç”¨æ­¤ç­†èª¿ç¯€</span>
                        <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                            <input v-model="drawer.simActive" type="checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                            <label class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-bold block mb-2">é è¨ˆæ¶ˆè€—é‡ (L)</label>
                        <input v-model.number="drawer.val" type="number" class="w-full bg-slate-100 p-4 rounded-xl text-4xl font-black text-center text-cyan-700 focus:ring-2 ring-cyan-500 outline-none">
                    </div>
                    <input v-model="drawer.simDesc" type="text" placeholder="å‚™è¨» (ä¾‹: é å€Ÿ/è£œå›/æ¸¬è©¦)" class="w-full bg-slate-50 p-3 rounded-xl font-bold border border-slate-200">
                    <p class="text-xs text-slate-400 text-center">
                        é–‹å•Ÿå¾Œï¼Œå°‡å¾åº«å­˜ä¸­æ‰£é™¤æ­¤æ•¸å€¼ã€‚<br>é©ç”¨æ–¼æœªä¾†çš„é æ¸¬æ€§èª¿æ•´ã€‚
                    </p>
                 </div>

            </div>
        </div>
    </div>

    <div class="toast" :class="{ 'show': toast.show }"><i class="fas fa-check-circle text-emerald-400"></i> {{ toast.msg }}</div>
</div>

<script>
    const { createApp, ref, computed, nextTick, onMounted } = Vue;
    const firebaseConfig = { apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo", authDomain: "crm-ts-1225-001.firebaseapp.com", databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com", projectId: "crm-ts-1225-001", storageBucket: "crm-ts-1225-001.firebasestorage.app", messagingSenderId: "925760221722", appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3" };
    const CSV_ROUTE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=216467280&single=true&output=csv';
    const CSV_HOME = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=59343971&single=true&output=csv';

    const ceil10 = (n) => Math.ceil(n * 10) / 10;

    createApp({
        setup() {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database().ref('milkBankV18'); 
            const rawRoute = ref([]); const rawHome = ref([]); const savedData = ref({});
            const drawer = ref({ show:false, mode:'', type:'', key:'', val:0 });
            const toast = ref({ show:false, msg:'' });
            const showHistory = ref(false);
            const sidebarOpen = ref(false);
            const fontLevel = ref(1); // 1, 1.3, 1.6
            const printMode = ref(false);
            
            const START = new Date('2026-02-04');
            const FILTER_DATE = '2026-02-13';
            const WEEK = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            const todayStr = new Date().toISOString().split('T')[0];
            
            const colorOptions = [
                { val:'blue', bg:'bg-blue-50', border:'border-blue-200' },
                { val:'red', bg:'bg-red-50', border:'border-red-200' },
                { val:'green', bg:'bg-green-50', border:'border-green-200' },
                { val:'yellow', bg:'bg-yellow-50', border:'border-yellow-200' },
                { val:'purple', bg:'bg-purple-50', border:'border-purple-200' }
            ];
            const taskOptions = ['å…¬ä¼‘æ—¥', 'å¿«é–ƒæ—¥', 'åœ˜è³¼æ—¥', 'åº«å­˜è™•ç†', 'é€è²¨æ—¥', 'ç›¤é»æ—¥'];

            onMounted(async () => {
                const [r1, r2] = await Promise.all([fetch(CSV_ROUTE).then(x=>x.text()), fetch(CSV_HOME).then(x=>x.text())]);
                parseRoute(r1); parseHome(r2);
                db.on('value', s => savedData.value = s.val()?.days || {});
            });

            const calculateBuckets = (stock) => {
                if(stock <= 0) return { b23:0, b30:0, left:0, total:0 };
                let remain = stock;
                let b23 = Math.floor(remain / 23);
                if(b23 > 4) b23 = 4;
                remain -= b23 * 23;
                let b30 = Math.floor(remain / 30);
                if(b30 > 2) b30 = 2;
                remain -= b30 * 30;
                let total = b23 + b30;
                if(remain > 0) total += 1;
                return { b23, b30, left: remain, total };
            };

            const days = computed(() => {
                let stock = 0; const res = [];
                for(let i=0; i<30; i++) {
                    const d = new Date(START); d.setDate(START.getDate()+i);
                    const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
                    const mStr = m < 10 ? '0'+m : m;
                    const dStr = dd < 10 ? '0'+dd : dd;
                    const key = `${y}-${mStr}-${dStr}`; 
                    
                    const wIdx = d.getDay();
                    const s = savedData.value[key] || {};
                    
                    let csvHome = 0; let bInfo = { big:0, small:0 };
                    const defList = (wIdx>=1 && wIdx<=5) ? (rawHome.value[wIdx-1]||[]) : [];
                    const actList = s.customList || defList; 
                    actList.forEach(it => {
                         csvHome += ((it.big*0.95)+(it.small*0.5));
                         bInfo.big+=it.big; bInfo.small+=it.small;
                    });
                    const finalHome = (s.deliveryHomeOverride !== undefined && s.deliveryHomeOverride !== null) 
                                      ? s.deliveryHomeOverride : csvHome;

                    const hAM = s.harvestAM ?? 13;
                    const hPM = s.harvestPM ?? 15;
                    const flash = s.flash || { vol:0, loc:'' };
                    const process = s.process || { vol:0, mantouBig:0, mantouSmall:0 };
                    
                    const adhoc = s.adhoc || { total:0, big:0, small:0, custom:0, active:false, desc:'' };
                    const adhocVol = adhoc.active ? adhoc.total : 0;
                    
                    const group = s.group || { vol:0 };
                    
                    const sims = [0,1,2,3].map(idx => {
                        return (s.sims && s.sims[idx]) ? s.sims[idx] : { val:0, active:false, desc:'' };
                    });
                    const simTotal = sims.reduce((acc, cur) => acc + (cur.active ? cur.val : 0), 0);

                    const nextDayIdx = (wIdx + 1) % 7;
                    let defaultPrep = (rawRoute.value[nextDayIdx] || 0) * 0.18;
                    let rPrep = s.routePrep !== undefined ? s.routePrep : defaultPrep;

                    if(i===0 && s.inventory===undefined) stock = 10;
                    if(s.inventory !== undefined) stock = s.inventory;
                    
                    const noon = ceil10(stock + hAM - finalHome);
                    const end = ceil10(stock + hAM + hPM - finalHome - flash.vol - process.vol - adhocVol - group.vol - rPrep - simTotal);
                    stock = end;

                    const colorMap = { blue:'hl-blue', red:'hl-red', green:'hl-green', yellow:'hl-yellow', purple:'hl-purple' };
                    const badgeColors = { blue:'#3b82f6', red:'#ef4444', green:'#22c55e', yellow:'#ca8a04', purple:'#a855f7' };

                    res.push({
                        key, dateStr:`${m}/${dd}`, weekDay: WEEK[wIdx], isWeekend: wIdx===0||wIdx===6,
                        isToday: key === todayStr,
                        startStock: s.inventory!==undefined?s.inventory:(i===0?10:res[i-1].endStock),
                        harvestAM: hAM, harvestPM: hPM, 
                        deliveryHome: finalHome, isHomeOverridden: (s.deliveryHomeOverride !== undefined && s.deliveryHomeOverride !== null),
                        csvHomeVal: csvHome, 
                        process, flash, adhoc, group, routePrep: rPrep, sims,
                        noonStock: noon, endStock: end, 
                        buckets: calculateBuckets(end),
                        bottleInfo: bInfo, rawHomeList: actList,
                        nextDayRoute: ((rawRoute.value[(wIdx+1)%7]||0)*0.18).toFixed(1),
                        afterNextRoute: ((rawRoute.value[(wIdx+2)%7]||0)*0.18).toFixed(1),
                        colorClass: colorMap[s.color] || '',
                        badgeColor: badgeColors[s.color] || '#64748b',
                        taskLabel: s.taskLabel
                    });
                }
                return res;
            });

            const filteredDays = computed(() => {
                if(printMode.value) {
                    // åˆ—å°å°ˆç”¨å€é–“ 2/15 - 3/01
                    return days.value.filter(d => d.key >= '2026-02-15' && d.key <= '2026-03-01');
                }
                if(showHistory.value) return days.value;
                return days.value.filter(d => d.key >= FILTER_DATE);
            });

            const printReport = () => {
                printMode.value = true;
                sidebarOpen.value = false;
                // ç­‰å¾… DOM æ›´æ–°å¾Œå†åˆ—å°
                nextTick(() => {
                    window.print();
                    // åˆ—å°å°è©±æ¡†é—œé–‰å¾Œ(æˆ–æ˜¯ç«‹å³)æ¢å¾©
                    // ç‚ºäº†é¿å…ç•«é¢è·³å‹•å¤ªå¿«ï¼Œé€™è£¡ä¸ä¸€å®šè¦ç«‹åˆ»åˆ‡å›ä¾†ï¼Œä½†ç‚ºäº† UX å¯ä»¥ç›£è½äº‹ä»¶ï¼Œé€™è£¡ç°¡å–®è™•ç†
                    setTimeout(() => { printMode.value = false; }, 1000);
                });
            };

            const edit = (type, d, idx=null) => {
                const titleMap = {inventory:'æœŸåˆåº«å­˜',harvestAM:'æ™¨é–“æ”¶ä¹³',harvestPM:'æ™šé–“æ”¶ä¹³',deliveryHome:'å®¶åº­å®…é…',process:'åŠ å·¥è£½ä½œ',flash:'å¿«é–ƒæ´»å‹•',adhoc:'è‡¨æ™‚è¨‚å–®',routePrep:'æ™¨é…é è£½', sim:'èª¿æ§é æ¸¬'};
                
                drawer.value = { 
                    show:true, mode:'input', type, key:d.key, 
                    dateLabel:`${d.dateStr} ${d.weekDay}`, 
                    title: (type==='sim' ? `èª¿æ§ ${['A','B','C','D'][idx]}` : titleMap[type]||type), 
                    val:d[type], 
                    isFriday: d.weekDay==='äº”', 
                    nextRoute:Number(d.nextDayRoute), afterNextRoute:Number(d.afterNextRoute) 
                };
                
                if(type==='process') { 
                    drawer.value.pSmall = d.process.mantouSmall || 0; 
                    drawer.value.pBig = d.process.mantouBig || 0; 
                }
                
                if(type==='adhoc') { 
                    drawer.value.adBig = d.adhoc.big||0; 
                    drawer.value.adSmall = d.adhoc.small||0; 
                    drawer.value.adCustom = d.adhoc.custom||0; 
                    drawer.value.adActive = d.adhoc.active !== false; 
                    if(d.adhoc.active === undefined && d.adhoc.total === 0) drawer.value.adActive = false; 
                    else if (d.adhoc.active === undefined) drawer.value.adActive = true; 
                    else drawer.value.adActive = d.adhoc.active;
                    drawer.value.adDesc = d.adhoc.desc || '';
                }

                if(type==='deliveryHome') {
                    drawer.value.val = d.isHomeOverridden ? d.deliveryHome : null; 
                    drawer.value.csvVal = d.csvHomeVal;
                    drawer.value.list = d.rawHomeList;
                }
                if(type==='sim') {
                    const s = d.sims[idx];
                    drawer.value.simIdx = idx;
                    drawer.value.val = s.val;
                    drawer.value.simActive = s.active;
                    drawer.value.simDesc = s.desc || '';
                }
            };

            const openDateSettings = (d) => {
                const s = savedData.value[d.key] || {};
                drawer.value = { show:true, mode:'settings', key:d.key, dateLabel:`${d.dateStr} ${d.weekDay}`, val:s.color, text:s.taskLabel };
            };

            const save = () => {
                const { key, type, val, adBig, adSmall, adCustom, adActive, adDesc, pSmall, pBig, simIdx, simActive, simDesc } = drawer.value;
                const path = `days/${key}`; const up = {};
                
                if(type==='adhoc') {
                    up[`${path}/adhoc`] = { 
                        total:(adBig*0.95)+(adSmall*0.5)+adCustom, 
                        big:adBig, small:adSmall, custom:adCustom,
                        active: adActive,
                        desc: adDesc 
                    }; 
                }
                else if(type==='process') { 
                    up[`${path}/process`] = { 
                        vol: (pSmall*3.7)+(pBig*1.3),
                        mantouSmall: pSmall,
                        mantouBig: pBig
                    }; 
                }
                else if(type==='flash') { const f=savedData.value[key]?.flash||{}; up[`${path}/flash`] = { vol:val, loc:f.loc||'' }; } 
                else if(type==='deliveryHome') { up[`${path}/deliveryHomeOverride`] = (val === null || val === '') ? null : Number(val); }
                else if(type==='sim') { up[`${path}/sims/${simIdx}`] = { val:Number(val), active:simActive, desc: simDesc }; }
                else up[`${path}/${type}`] = Number(val);
                
                db.update(up).then(()=>{ toast.value={show:true,msg:'å„²å­˜æˆåŠŸ'}; setTimeout(()=>toast.value.show=false,1500); drawer.value.show=false; });
            };

            const saveDateSettings = () => {
                const { key, val, text } = drawer.value;
                db.child(`days/${key}`).update({ color:val, taskLabel:text });
                drawer.value.show = false;
            };

            const adj=(n)=>drawer.value.val=parseFloat((drawer.value.val+n).toFixed(1));
            const setDateColor=(c)=>drawer.value.val=c; const setDateTask=(t)=>drawer.value.text=t;
            
            const parseRoute=(t)=>{const r=t.split('\n').slice(1);const res=[0,0,0,0,0,0,0];r.forEach(x=>{const c=x.split(',');if(c.length<3)return;for(let d=0;d<7;d++){let s=0;for(let k=0;k<5;k++)s+=(parseInt(c[(3+((d===0?6:d-1)*5))+k]?.replace(/ï¼’/g,'2'))||0);res[d]+=s;}});rawRoute.value=res;};
            const parseHome=(t)=>{const r=t.split('\n').slice(1);const d=[[],[],[],[],[]];r.forEach(x=>{const c=x.split(',');if(c.length<2)return;for(let i=0;i<5;i++){const b=parseInt(c[2+i*2])||0,s=parseInt(c[3+i*2])||0;if(b||s)d[i].push({uuid:c[0],name:c[1],big:b,small:s});}});rawHome.value=d;};

            return { days, filteredDays, todayEndStock:computed(()=>days.value.find(d=>d.isToday)?.endStock||0), drawer, toast, colorOptions, taskOptions, showHistory, sidebarOpen, fontLevel, edit, openDateSettings, save, saveDateSettings, setDateColor, setDateTask, adj, printReport };
        }
    }).mount('#app');
</script>
</body>
</html>