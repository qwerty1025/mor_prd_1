<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>五寮尖生乳存摺 V13.0 運籌版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        [v-cloak] { display: none; }
        
        /* 表格樣式優化 */
        .milk-table { border-collapse: separate; border-spacing: 0; w-full; }
        .milk-table th, .milk-table td { 
            padding: 8px 4px; text-align: center; border-bottom: 1px solid #e2e8f0; 
            border-right: 1px dashed #e2e8f0; white-space: nowrap; font-size: 13px; position: relative;
        }
        /* 凍結首欄 */
        .milk-table td:first-child, .milk-table th:first-child {
            position: sticky; left: 0; background-color: #fff; z-index: 20;
            border-right: 2px solid #cbd5e1; text-align: left; padding-left: 12px;
            color: #475569; font-size: 12px; font-weight: 700; min-width: 100px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .milk-table thead th { position: sticky; top: 0; z-index: 10; background-color: #f1f5f9; height: 45px; }
        .milk-table thead th:first-child { z-index: 30; }

        /* 數值字體 */
        .num-font { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
        
        /* 狀態色系 */
        .cell-editable { cursor: pointer; transition: background 0.1s; }
        .cell-editable:active { background-color: #f1f5f9; }
        
        .val-plus { color: #059669; font-weight: 600; }
        .val-minus { color: #dc2626; font-weight: 600; }
        .val-pre { color: #7c3aed; font-weight: 700; background-color: #f3e8ff; border-radius: 4px; padding: 2px 4px; font-size: 11px; }
        .val-done-early { color: #94a3b8; text-decoration: line-through; font-size: 11px; }

        .manual-dot { position: absolute; top: 3px; right: 3px; width: 6px; height: 6px; background: #6366f1; border-radius: 50%; }

        /* 月曆標籤 */
        .cal-chip { font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* 底部抽屜動畫 */
        .drawer-enter-active, .drawer-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .drawer-enter-from, .drawer-leave-to { transform: translateY(100%); }
        
        .backdrop-enter-active, .backdrop-leave-active { transition: opacity 0.3s; }
        .backdrop-enter-from, .backdrop-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen overflow-hidden text-slate-800">

<div id="app" v-cloak class="h-full flex flex-col">

    <header class="bg-white px-4 py-3 border-b border-slate-200 flex-none z-30 flex justify-between items-center shadow-sm">
        <div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">今日庫存 ({{ todayStr }})</div>
            <div class="text-3xl font-black text-slate-800 num-font leading-none mt-1">{{ todayEndStock.toFixed(1) }} <span class="text-sm text-slate-400 font-medium">L</span></div>
        </div>
        <button @click="toggleView" class="bg-slate-100 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center shadow-sm active:scale-95 transition">
            <i :class="viewMode === 'list' ? 'fas fa-calendar-alt' : 'fas fa-list'"></i>
        </button>
    </header>

    <main class="flex-1 bg-white relative overflow-hidden">
        
        <div v-if="viewMode === 'list'" class="h-full overflow-auto pb-32 overscroll-contain">
            <table class="milk-table w-full">
                <thead>
                    <tr>
                        <th class="h-10 bg-slate-50 border-r-2"><i class="fas fa-bars mr-1"></i> 項目</th>
                        <th v-for="day in milkBankDays" :key="day.key" class="min-w-[70px]" :class="{'bg-orange-50': day.isWeekend}">
                            <div class="flex flex-col items-center leading-tight">
                                <span class="text-xs font-black" :class="day.isWeekend ? 'text-red-500' : 'text-slate-600'">{{ day.weekDay }}</span>
                                <span class="text-[9px] text-slate-400">{{ day.dateLabel }}</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="w-1 h-4 bg-slate-300 inline-block align-middle mr-1 rounded"></span>期初</td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openDrawer('inventory', day)" class="cell-editable num-font text-slate-400 text-xs">
                            {{ day.startStock.toFixed(1) }}
                        </td>
                    </tr>
                    
                    <tr>
                        <td><span class="w-1 h-4 bg-emerald-400 inline-block align-middle mr-1 rounded"></span>晨收</td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openDrawer('harvestAM', day)" class="cell-editable val-plus num-font">
                            +{{ day.harvestAM }}
                            <div v-if="day.isManual.harvestAM" class="manual-dot"></div>
                        </td>
                    </tr>

                    <tr>
                        <td><span class="w-1 h-4 bg-red-400 inline-block align-middle mr-1 rounded"></span>晨配</td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openDrawer('deliveryRoute', day)" class="cell-editable num-font">
                            <div v-if="day.preFilled.route" class="val-done-early">
                                預作完畢
                            </div>
                            <div v-else class="val-minus">
                                {{ day.deliveryRoute > 0 ? '-' + day.deliveryRoute.toFixed(1) : '-' }}
                            </div>
                            <div v-if="day.isManual.deliveryRoute" class="manual-dot"></div>
                        </td>
                    </tr>

                    <tr class="bg-purple-50/50">
                        <td class="border-l-4 border-l-purple-500"><i class="fas fa-clock text-purple-500 mr-1"></i><span class="font-bold text-purple-900">提前預作</span></td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openDrawer('advance', day)" class="cell-editable">
                            <div v-for="(task, idx) in day.advanceTasks" :key="idx" class="val-pre mb-1">
                                -{{ task.vol }}L <span class="scale-90 inline-block">{{ task.label }}</span>
                            </div>
                            <div v-if="day.advanceTasks.length === 0" class="text-purple-200 text-xs">-</div>
                        </td>
                    </tr>

                    <tr>
                        <td><span class="w-1 h-4 bg-blue-500 inline-block align-middle mr-1 rounded"></span>家庭號</td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openChecklist(day)" class="cell-editable num-font font-bold">
                            <div v-if="day.preFilled.home" class="val-done-early">
                                預作完畢
                            </div>
                            <div v-else class="text-blue-600">
                                {{ day.deliveryHome > 0 ? '-' + day.deliveryHome.toFixed(1) : '-' }}
                            </div>
                            
                            <div v-if="!day.preFilled.home && day.deliveryHome > 0" class="absolute bottom-1 right-1 flex gap-0.5">
                                <div v-if="day.homeStatus.partial > 0" class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                <div v-if="day.homeStatus.pending === 0" class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td><span class="w-1 h-4 bg-pink-400 inline-block align-middle mr-1 rounded"></span>活動/加工</td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openDrawer('special', day)" class="cell-editable text-xs">
                            <div v-if="day.flash.vol > 0" class="text-pink-600 font-bold mb-1">-{{ day.flash.vol }}L</div>
                            <div v-if="day.process.vol > 0" class="text-amber-600 font-bold">-{{ day.process.vol.toFixed(1) }}L</div>
                            <div v-if="day.flash.vol===0 && day.process.vol===0" class="text-slate-200">-</div>
                        </td>
                    </tr>

                    <tr>
                        <td><span class="w-1 h-4 bg-indigo-400 inline-block align-middle mr-1 rounded"></span>晚收</td>
                        <td v-for="day in milkBankDays" :key="day.key" @click="openDrawer('harvestPM', day)" class="cell-editable val-plus num-font">
                            +{{ day.harvestPM }}
                        </td>
                    </tr>

                    <tr class="bg-slate-50 font-black">
                        <td class="text-slate-800">結餘</td>
                        <td v-for="day in milkBankDays" :key="day.key" 
                            class="num-font text-sm"
                            :class="day.endStock < 0 ? 'bg-red-100 text-red-600' : 'text-blue-700'">
                            {{ day.endStock.toFixed(1) }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div v-else class="h-full overflow-y-auto pb-32 bg-slate-100 p-2">
            <div class="grid grid-cols-7 gap-2 mb-20">
                <div v-for="w in ['日','一','二','三','四','五','六']" :key="w" class="text-center text-xs font-bold text-slate-400 py-1">{{w}}</div>
                
                <div v-for="n in startDayOffset" :key="'e'+n" class="invisible"></div>

                <div v-for="day in milkBankDays" :key="day.key" 
                     @click="openDrawer('inventory', day)"
                     class="bg-white rounded-lg p-1.5 min-h-[100px] flex flex-col shadow-sm border border-slate-100 relative"
                     :class="{'ring-2 ring-red-200 bg-red-50': day.endStock < 0}">
                    
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-sm font-bold" :class="day.isWeekend?'text-red-500':'text-slate-700'">{{ day.dateLabel }}</span>
                        <span class="text-[8px] text-slate-400 scale-90 origin-right">{{ day.lunar }}</span>
                    </div>

                    <div class="flex-1 flex flex-col gap-1 overflow-hidden">
                        <div v-for="task in day.advanceTasks" class="cal-chip bg-purple-100 text-purple-700 font-bold">
                            <i class="fas fa-forward text-[8px] mr-1"></i>{{ task.label }}
                        </div>
                        <div v-if="day.flash.vol > 0" class="cal-chip bg-pink-100 text-pink-700">
                            <i class="fas fa-star text-[8px] mr-1"></i>{{ day.flash.loc }}
                        </div>
                        <div v-if="day.process.vol > 0" class="cal-chip bg-amber-100 text-amber-800">
                             <i class="fas fa-cookie text-[8px] mr-1"></i>{{ day.process.vol.toFixed(0) }}L
                        </div>
                    </div>

                    <div class="mt-auto text-right font-mono font-black text-sm" :class="day.endStock < 0 ? 'text-red-600':'text-blue-600'">
                        {{ day.endStock.toFixed(0) }}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <teleport to="body">
        <transition name="backdrop">
            <div v-if="drawer.show" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-40" @click="closeDrawer"></div>
        </transition>

        <transition name="drawer">
            <div v-if="drawer.show" class="fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-3xl shadow-2xl flex flex-col max-h-[85vh]">
                
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-3xl flex-none">
                    <div>
                        <div class="text-xs font-bold text-slate-400 mb-0.5">{{ drawer.dateLabel }}</div>
                        <h3 class="text-xl font-black text-slate-800 flex items-center gap-2">
                            <i :class="drawer.icon" class="text-blue-600 text-lg"></i>
                            {{ drawer.title }}
                        </h3>
                    </div>
                    <button @click="closeDrawer" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto overflow-x-hidden flex-1 safe-bottom">
                    
                    <div v-if="drawer.mode === 'number'" class="flex flex-col items-center gap-6">
                        <div class="flex items-center justify-center gap-4 w-full">
                            <button @click="adj(-1)" class="w-14 h-14 bg-slate-100 rounded-2xl text-xl font-bold text-slate-600 shadow-sm active:scale-95 transition"><i class="fas fa-minus"></i></button>
                            <input v-model.number="drawer.val" type="number" step="0.5" class="w-32 text-center text-5xl font-black text-slate-800 bg-transparent focus:outline-none p-0">
                            <button @click="adj(1)" class="w-14 h-14 bg-slate-100 rounded-2xl text-xl font-bold text-slate-600 shadow-sm active:scale-95 transition"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="grid grid-cols-4 gap-2 w-full mt-2">
                            <button @click="adj(5)" class="py-2 bg-slate-50 rounded-lg text-xs font-bold text-slate-500">+5</button>
                            <button @click="adj(10)" class="py-2 bg-slate-50 rounded-lg text-xs font-bold text-slate-500">+10</button>
                            <button @click="adj(-5)" class="py-2 bg-slate-50 rounded-lg text-xs font-bold text-slate-500">-5</button>
                            <button @click="adj(-10)" class="py-2 bg-slate-50 rounded-lg text-xs font-bold text-slate-500">-10</button>
                        </div>
                    </div>

                    <div v-if="drawer.mode === 'advance'" class="space-y-4">
                        <p class="text-sm text-slate-500 mb-2">將未來的配送工作，提前至今日製作/裝瓶，並扣除今日庫存。</p>
                        
                        <div v-for="opt in drawer.advanceOptions" :key="opt.id" 
                             @click="toggleAdvanceTask(opt)"
                             class="p-4 rounded-xl border-2 flex justify-between items-center transition-all cursor-pointer"
                             :class="opt.active ? 'border-purple-500 bg-purple-50' : 'border-slate-100 bg-slate-50'">
                            <div>
                                <div class="font-bold text-slate-800">{{ opt.name }}</div>
                                <div class="text-xs text-slate-500">預估耗用: <span class="font-bold text-purple-600">{{ opt.estVol }} L</span></div>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center"
                                 :class="opt.active ? 'border-purple-500 bg-purple-500 text-white' : 'border-slate-300'">
                                <i v-if="opt.active" class="fas fa-check text-xs"></i>
                            </div>
                        </div>

                        <div v-if="drawer.advanceOptions.length === 0" class="text-center py-6 bg-slate-50 rounded-xl text-slate-400 text-sm">
                            <i class="fas fa-ban mb-2 text-xl block"></i>
                            無可用的提前調度建議
                        </div>
                    </div>

                    <div v-if="drawer.mode === 'special'" class="space-y-6">
                        <div class="bg-pink-50 p-4 rounded-2xl border border-pink-100">
                            <div class="font-bold text-pink-800 mb-3 flex items-center"><i class="fas fa-bullhorn mr-2"></i>快閃活動</div>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <label class="text-xs font-bold text-pink-400 w-12">數量</label>
                                    <input v-model.number="drawer.flashVal" type="number" class="flex-1 bg-white px-3 py-2 rounded-lg font-bold text-lg border border-pink-200">
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="text-xs font-bold text-pink-400 w-12">地點</label>
                                    <input v-model="drawer.flashLoc" type="text" placeholder="活動說明" class="flex-1 bg-white px-3 py-2 rounded-lg text-sm border border-pink-200">
                                </div>
                            </div>
                        </div>

                        <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100">
                            <div class="font-bold text-amber-800 mb-3 flex items-center"><i class="fas fa-cookie-bite mr-2"></i>加工製作</div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <button @click="drawer.pSmall++" class="bg-white p-2 rounded-xl border border-amber-200 shadow-sm active:scale-95">
                                    <div class="text-xs text-amber-600">小饅頭</div>
                                    <div class="text-xl font-black text-amber-800">{{ drawer.pSmall }}</div>
                                </button>
                                <button @click="drawer.pBig++" class="bg-white p-2 rounded-xl border border-amber-200 shadow-sm active:scale-95">
                                    <div class="text-xs text-amber-600">大饅頭</div>
                                    <div class="text-xl font-black text-amber-800">{{ drawer.pBig }}</div>
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-amber-600 font-bold">總耗用: {{ ((drawer.pSmall*3.7)+(drawer.pBig*1.3)).toFixed(1) }} L</span>
                                <button @click="drawer.pSmall=0;drawer.pBig=0" class="text-[10px] text-amber-400 underline">重置</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="drawer.mode === 'checklist'" class="space-y-2">
                        <div v-if="drawer.list.length === 0" class="text-center py-10 text-slate-400">本日無訂單</div>
                        <div v-for="(item, idx) in drawer.list" :key="idx" 
                             class="flex items-center justify-between p-3 rounded-xl border transition-all"
                             :class="getItemClass(item)">
                            
                            <div @click="toggleStatus(idx, 'split')" class="flex-1">
                                <div class="font-bold text-slate-800 text-sm">{{ item.name }}</div>
                                <div class="text-xs font-mono text-slate-500">
                                    {{ item.big>0 ? item.big+'大' : '' }} {{ item.small>0 ? item.small+'小' : '' }}
                                    <span class="text-slate-300 mx-1">|</span>
                                    {{ ((item.big*0.95)+(item.small*0.5)).toFixed(2) }}L
                                </div>
                            </div>

                            <button @click="toggleStatus(idx, 'done')" 
                                    class="w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-sm"
                                    :class="item.status==='done' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-300'">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>

                </div>

                <div class="p-4 border-t border-slate-100 bg-white safe-bottom">
                    <button @click="saveDrawer" class="w-full bg-blue-600 text-white font-bold text-lg py-3 rounded-xl shadow-lg shadow-blue-200 active:scale-[0.98] transition">
                        確認儲存
                    </button>
                </div>

            </div>
        </transition>
    </teleport>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    // 模擬資料 (實際運作時建議替換為 fetch)
    const CSV_ROUTE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=216467280&single=true&output=csv';
    const CSV_HOME = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=59343971&single=true&output=csv';

    createApp({
        setup() {
            // --- State ---
            const rawRoute = ref(new Array(7).fill(0));
            const rawHome = ref(new Array(5).fill([])); // Mon-Fri lists
            const savedData = ref({});
            const viewMode = ref('list');
            const drawer = ref({ 
                show: false, mode: '', title: '', dateLabel: '', key: '', icon: '',
                val: 0, 
                // Special
                flashVal: 0, flashLoc: '', pSmall: 0, pBig: 0,
                // Checklist
                list: [],
                // Advance
                advanceOptions: []
            });

            // Config
            const START_DATE = new Date('2026-02-04'); // Wednesday
            const WEEK_DAYS = ['日','一','二','三','四','五','六'];

            // --- Init ---
            onMounted(async () => {
                const stored = localStorage.getItem('milkBankV13');
                if(stored) savedData.value = JSON.parse(stored);
                
                await Promise.all([
                    fetch(CSV_ROUTE).then(r=>r.text()).then(parseRoute),
                    fetch(CSV_HOME).then(r=>r.text()).then(parseHome)
                ]);
            });

            // --- Parsers ---
            const parseRoute = (txt) => {
                const rows = txt.trim().split('\n').slice(1);
                const res = [0,0,0,0,0,0,0];
                rows.forEach(r => {
                    const c = r.split(',');
                    if(c.length<3) return;
                    for(let d=0; d<7; d++) {
                        // Map CSV col to weekday. Sun=Col6, Mon=Col1...
                        const sIdx = d===0 ? 6 : d-1; 
                        const base = 3 + (sIdx*5);
                        let sum = 0;
                        for(let k=0; k<5; k++) sum += (parseInt(c[base+k]?.replace(/２/g,'2'))||0);
                        res[d] += sum;
                    }
                });
                rawRoute.value = res;
            };

            const parseHome = (txt) => {
                const rows = txt.trim().split('\n').slice(1);
                const days = [[],[],[],[],[]];
                rows.forEach(r => {
                    const c = r.split(',');
                    if(c.length<2) return;
                    const uuid = c[0];
                    const name = c[1];
                    for(let i=0; i<5; i++) {
                        const big = parseInt(c[2 + i*2]) || 0;
                        const small = parseInt(c[3 + i*2]) || 0;
                        if(big>0 || small>0) days[i].push({ uuid, name, big, small });
                    }
                });
                rawHome.value = days;
            };

            // --- Core Logic ---
            const milkBankDays = computed(() => {
                const list = [];
                let runningStock = 0;
                // 為了處理提前製作，我們需要先建立一個 map 來標記哪些天被預先完成了
                // Map Key: DateString, Value: { route: boolean, home: boolean }
                const preFilledMap = {}; 

                // 第一次遍歷：掃描所有「提前任務」並標記未來的日子
                for(let i=0; i<30; i++) {
                    const { dateKey } = getDateInfo(i);
                    const saved = savedData.value[dateKey] || {};
                    const tasks = saved.advanceTasks || []; // [{ type: 'pre_route', target: '2026-02-xx' }]
                    
                    tasks.forEach(t => {
                        if(!preFilledMap[t.target]) preFilledMap[t.target] = {};
                        if(t.type === 'route') preFilledMap[t.target].route = true;
                        if(t.type === 'home') preFilledMap[t.target].home = true;
                    });
                }

                // 第二次遍歷：計算庫存
                for(let i=0; i<30; i++) {
                    const { dateKey, y, m, d, dayIdx, dateLabel } = getDateInfo(i);
                    const saved = savedData.value[dateKey] || {};

                    // 1. Basic Data
                    let startStock = (i===0 && saved.inventory===undefined) ? 10 : (saved.inventory ?? runningStock);
                    const harvestAM = saved.harvestAM ?? 13;
                    const harvestPM = saved.harvestPM ?? 15;
                    
                    // 2. Route Delivery
                    let deliveryRoute = (rawRoute.value[dayIdx] || 0) * 0.18;
                    if(saved.deliveryRoute !== undefined) deliveryRoute = saved.deliveryRoute;
                    
                    // Check Pre-filled
                    const isRoutePreFilled = preFilledMap[dateKey]?.route;
                    if(isRoutePreFilled) deliveryRoute = 0; // Already deducted previously

                    // 3. Home Delivery
                    let deliveryHome = 0;
                    const homeStatus = { pending:0, partial:0, done:0, total:0 };
                    let homeList = [];
                    if(dayIdx >=1 && dayIdx <=5) homeList = rawHome.value[dayIdx-1] || [];

                    homeList.forEach(item => {
                        homeStatus.total++;
                        const stat = (saved.checklist || {})[item.uuid] || 'done'; 
                        if(stat === 'done') homeStatus.done++;
                        else if(stat === 'split') homeStatus.partial++;
                        else homeStatus.pending++;

                        if(stat !== 'skip') {
                            const vol = (item.big*0.95) + (item.small*0.5);
                            deliveryHome += (stat === 'split' ? vol*0.5 : vol);
                        }
                    });
                    
                    // Check Pre-filled
                    const isHomePreFilled = preFilledMap[dateKey]?.home;
                    if(isHomePreFilled) deliveryHome = 0;

                    // 4. Extra Tasks (Flash, Process, Advance)
                    const flash = saved.flash || { vol:0, loc:'' };
                    const process = saved.process || { vol:0, desc:'' };
                    const advanceTasks = saved.advanceTasks || []; // [{ vol: 50, label: 'Sat Route' }]
                    const advanceVol = advanceTasks.reduce((acc, t) => acc + t.vol, 0);

                    // 5. Calc End Stock
                    const endStock = startStock + harvestAM + harvestPM - deliveryRoute - deliveryHome - flash.vol - process.vol - advanceVol;
                    runningStock = endStock;

                    // Lunar
                    let lunar = '';
                    try { lunar = Lunar.fromSolar(Solar.fromYmd(y,m,d)).getDayInChinese(); } catch(e){}

                    list.push({
                        key: dateKey, dateLabel, weekDay: WEEK_DAYS[dayIdx], isWeekend: dayIdx===0||dayIdx===6,
                        lunar,
                        startStock, harvestAM, harvestPM, 
                        deliveryRoute, deliveryHome,
                        flash, process, advanceTasks,
                        endStock,
                        homeStatus,
                        preFilled: { route: isRoutePreFilled, home: isHomePreFilled },
                        rawHomeList: homeList,
                        isManual: {
                            inventory: saved.inventory!==undefined,
                            harvestAM: saved.harvestAM!==undefined,
                            deliveryRoute: saved.deliveryRoute!==undefined
                        }
                    });
                }
                return list;
            });

            const getDateInfo = (offset) => {
                const dObj = new Date(START_DATE);
                dObj.setDate(START_DATE.getDate() + offset);
                const y = dObj.getFullYear();
                const m = dObj.getMonth()+1;
                const d = dObj.getDate();
                const dateKey = `${y}-${m}-${d}`;
                return { dateKey, y, m, d, dayIdx: dObj.getDay(), dateLabel: `${m}/${d}` };
            }

            const todayEndStock = computed(() => milkBankDays.value[0]?.endStock || 0);
            const todayStr = computed(() => milkBankDays.value[0]?.dateLabel || '');
            const startDayOffset = computed(() => new Date(START_DATE).getDay()); // For calendar grid padding

            // --- Drawer Actions ---
            const openDrawer = (mode, day) => {
                drawer.value.show = true;
                drawer.value.mode = mode;
                drawer.value.key = day.key;
                drawer.value.dateLabel = `${day.dateLabel} ${day.weekDay}`;
                
                // Set Title & Icon
                const configs = {
                    inventory: { t: '期初庫存', i: 'fa-cube' },
                    harvestAM: { t: '晨間收乳', i: 'fa-sun' },
                    harvestPM: { t: '晚間收乳', i: 'fa-moon' },
                    deliveryRoute: { t: '晨間配送', i: 'fa-truck' },
                    special: { t: '加工與快閃', i: 'fa-star' },
                    advance: { t: '提前調度作業', i: 'fa-clock' }
                };
                if(configs[mode]) {
                    drawer.value.title = configs[mode].t;
                    drawer.value.icon = configs[mode].i;
                }

                // Load Data
                if(mode === 'special') {
                    drawer.value.flashVal = day.flash.vol;
                    drawer.value.flashLoc = day.flash.loc;
                    // Reverse engineer process sets? Simplified: reset counts
                    drawer.value.pSmall = 0; drawer.value.pBig = 0;
                } else if (mode === 'advance') {
                    prepareAdvanceOptions(day);
                } else if (['inventory','harvestAM','harvestPM','deliveryRoute'].includes(mode)) {
                    drawer.value.mode = 'number';
                    drawer.value.val = day[mode];
                }
            };

            const openChecklist = (day) => {
                drawer.value.show = true;
                drawer.value.mode = 'checklist';
                drawer.value.key = day.key;
                drawer.value.title = '家庭號出貨表';
                drawer.value.icon = 'fa-users';
                drawer.value.dateLabel = day.dateLabel;

                const saved = (savedData.value[day.key] || {}).checklist || {};
                drawer.value.list = day.rawHomeList.map(i => ({
                    ...i,
                    status: saved[i.uuid] || 'done'
                }));
            };

            // --- Advance Logic (The New Feature) ---
            const prepareAdvanceOptions = (day) => {
                const opts = [];
                const dObj = new Date(day.key);
                const dayIdx = dObj.getDay();
                
                // Helper to get target date key
                const getTargetKey = (offset) => {
                    const t = new Date(dObj);
                    t.setDate(dObj.getDate() + offset);
                    return `${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`;
                };

                // Logic:
                // If Friday (5) -> Can do Sat(6) Route, Sun(0) Route
                // If Sunday (0) -> Can do Mon(1) Home
                // If Saturday (6) -> Can do Sun(0) Route?
                
                // Rule 1: Route Pre-fill (Next Day)
                // 檢查明天是否有晨配
                const nextDayIdx = (dayIdx + 1) % 7;
                const nextKey = getTargetKey(1);
                const nextRouteVol = (rawRoute.value[nextDayIdx] || 0) * 0.18;
                
                if(nextRouteVol > 0) {
                    const existing = (day.advanceTasks || []).find(t => t.target === nextKey && t.type === 'route');
                    opts.push({
                        id: 'next_route',
                        name: `預裝明日 (${WEEK_DAYS[nextDayIdx]}) 晨配`,
                        estVol: nextRouteVol.toFixed(1),
                        active: !!existing,
                        taskData: { type: 'route', target: nextKey, vol: parseFloat(nextRouteVol.toFixed(1)), label: `預${WEEK_DAYS[nextDayIdx]}配` }
                    });
                }

                // Rule 2: Special Weekend Logic on Friday
                if(dayIdx === 5) { // Friday
                    const sunKey = getTargetKey(2);
                    const sunRouteVol = (rawRoute.value[0] || 0) * 0.18;
                    const existing = (day.advanceTasks || []).find(t => t.target === sunKey && t.type === 'route');
                    opts.push({
                        id: 'sun_route',
                        name: `預裝週日 (${WEEK_DAYS[0]}) 晨配`,
                        estVol: sunRouteVol.toFixed(1),
                        active: !!existing,
                        taskData: { type: 'route', target: sunKey, vol: parseFloat(sunRouteVol.toFixed(1)), label: `預${WEEK_DAYS[0]}配` }
                    });
                }

                // Rule 3: Home Pre-fill (Mon on Sun)
                if(dayIdx === 0) { // Sunday
                    const monKey = getTargetKey(1);
                    // Calc Mon Volume
                    const monList = rawHome.value[0] || [];
                    let monVol = 0;
                    monList.forEach(i => monVol += ((i.big*0.95) + (i.small*0.5)));
                    
                    if(monVol > 0) {
                        const existing = (day.advanceTasks || []).find(t => t.target === monKey && t.type === 'home');
                        opts.push({
                            id: 'mon_home',
                            name: `預裝週一家庭號`,
                            estVol: monVol.toFixed(1),
                            active: !!existing,
                            taskData: { type: 'home', target: monKey, vol: parseFloat(monVol.toFixed(1)), label: '預週一宅' }
                        });
                    }
                }

                drawer.value.advanceOptions = opts;
            };

            const toggleAdvanceTask = (opt) => {
                opt.active = !opt.active;
            };

            // --- Save & Update ---
            const saveDrawer = () => {
                const { key, mode } = drawer.value;
                if(!savedData.value[key]) savedData.value[key] = {};
                const daySave = savedData.value[key];

                if(mode === 'number') {
                    // map drawer.title/icon logic back to field name? simpler to store field name in drawer
                    // Let's rely on mapping:
                    if(drawer.value.title.includes('期初')) daySave.inventory = drawer.value.val;
                    if(drawer.value.title.includes('晨間收')) daySave.harvestAM = drawer.value.val;
                    if(drawer.value.title.includes('晚間收')) daySave.harvestPM = drawer.value.val;
                    if(drawer.value.title.includes('晨間配')) daySave.deliveryRoute = drawer.value.val;
                }
                else if(mode === 'special') {
                    daySave.flash = { vol: drawer.value.flashVal, loc: drawer.value.flashLoc };
                    if(drawer.value.pSmall > 0 || drawer.value.pBig > 0) {
                        const v = (drawer.value.pSmall*3.7) + (drawer.value.pBig*1.3);
                        daySave.process = { vol: v, desc: `小${drawer.value.pSmall}大${drawer.value.pBig}` };
                    }
                }
                else if(mode === 'checklist') {
                    const map = {};
                    drawer.value.list.forEach(i => map[i.uuid] = i.status);
                    daySave.checklist = map;
                }
                else if(mode === 'advance') {
                    // Re-construct tasks list
                    // Preserve other tasks not managed by options? (For V13, assume options cover all)
                    const newTasks = drawer.value.advanceOptions.filter(o => o.active).map(o => o.taskData);
                    daySave.advanceTasks = newTasks;
                }

                saveToLocal();
                closeDrawer();
            };

            const toggleStatus = (idx, status) => {
                const item = drawer.value.list[idx];
                item.status = (item.status === status) ? 'skip' : status;
            };
            
            const getItemClass = (item) => {
                if(item.status === 'skip') return 'bg-slate-50 opacity-50 border-slate-100';
                if(item.status === 'split') return 'bg-red-50 border-red-200';
                if(item.status === 'done') return 'bg-blue-50 border-blue-200';
                return 'bg-white border-slate-100';
            };

            const adj = (d) => drawer.value.val = parseFloat((drawer.value.val + d).toFixed(1));
            const closeDrawer = () => drawer.value.show = false;
            const toggleView = () => viewMode.value = viewMode.value === 'list' ? 'calendar' : 'list';
            const saveToLocal = () => localStorage.setItem('milkBankV13', JSON.stringify(savedData.value));

            return { 
                milkBankDays, todayEndStock, todayStr, viewMode, drawer, startDayOffset,
                openDrawer, closeDrawer, saveDrawer, toggleView, adj,
                openChecklist, toggleStatus, getItemClass, toggleAdvanceTask
            };
        }
    }).mount('#app');
</script>
</body>
</html>
