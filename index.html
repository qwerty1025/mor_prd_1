<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>五寮尖生乳存摺 V10.0 (Firebase版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f8fafc; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        [v-cloak] { display: none; }
        
        .milk-table-container { 
            overflow-x: auto; 
            position: relative; 
            height: calc(100vh - 180px); 
            -webkit-overflow-scrolling: touch;
        }
        .milk-table { border-collapse: separate; border-spacing: 0; }
        .milk-table th, .milk-table td { 
            padding: 8px 4px; 
            text-align: center; 
            border-bottom: 1px solid #e2e8f0; 
            border-right: 1px solid #f1f5f9;
            white-space: nowrap;
            font-size: 13px;
            font-weight: 700;
        }
        /* 凍結首欄 */
        .milk-table td:first-child, .milk-table th:first-child {
            position: sticky; left: 0; background-color: #fff; z-index: 20;
            border-right: 2px solid #e2e8f0; text-align: left; padding-left: 12px;
            color: #64748b; font-size: 11px; min-width: 100px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }
        /* 凍結首列 */
        .milk-table thead th {
            position: sticky; top: 0; z-index: 10; background-color: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        .milk-table thead th:first-child { z-index: 30; background-color: #f8fafc; }

        /* 互動樣式 */
        .editable-cell { cursor: pointer; transition: background 0.2s; }
        .editable-cell:active { background-color: #f1f5f9; }
        .val-input { color: #10b981; } 
        .val-adhoc { color: #ef4444; }
        .val-balance { color: #3b82f6; font-weight: 900; background-color: #eff6ff; }
        .val-negative { color: #ef4444; background-color: #fef2f2; }
        
        .manual-dot {
            position: absolute; top: 4px; right: 4px; 
            width: 5px; h-5px; border-radius: 50%;
            background-color: #6366f1;
        }
        
        .lunar-text { font-size: 9px; color: #94a3b8; font-weight: normal; margin-top: 1px; }
        .weekend-col { background-color: #fff7ed; }
        
        /* 連線狀態燈 */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-offline { background-color: #ef4444; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col text-slate-800">

<div id="app" v-cloak class="h-full flex flex-col relative">

    <header class="bg-white px-4 py-3 border-b border-slate-100 flex-none z-30 shadow-sm">
        <div class="flex justify-between items-end">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-[10px] font-bold text-slate-400">今日預估結餘 (22:00)</span>
                    <div class="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded-full">
                        <span class="status-dot" :class="firebaseConnected ? 'status-online' : 'status-offline'"></span>
                        <span class="text-[9px] text-slate-500">{{ firebaseConnected ? '雲端同步中' : '離線模式' }}</span>
                    </div>
                </div>
                <div class="text-3xl font-black text-slate-800 flex items-baseline gap-1">
                    {{ todayEndStock.toFixed(2) }} <span class="text-sm text-slate-500 font-bold">kg</span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] font-bold text-slate-400 mb-1">週期範圍</div>
                <div class="text-xs font-bold text-blue-600">
                    今天 <i class="fas fa-arrow-right text-[10px]"></i> 2026/02/24
                </div>
            </div>
        </div>
        <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2 overflow-hidden">
            <div class="bg-blue-500 h-full transition-all duration-500" :style="{ width: Math.min(100, Math.max(0, (todayEndStock / 100) * 100)) + '%' }"></div>
        </div>
    </header>

    <main class="flex-1 bg-white relative overflow-hidden flex flex-col pb-20">
        <div class="milk-table-container h-full">
            <table class="milk-table">
                <thead>
                    <tr>
                        <th class="h-14 bg-slate-50 border-r-2"><div class="pt-2 pl-1">項目 \ 日期</div></th>
                        <th v-for="(day, idx) in milkBankDays" :key="idx" class="min-w-[85px]" :class="{'bg-orange-50': day.isWeekend}">
                            <div class="flex flex-col items-center justify-center h-full">
                                <span class="text-[10px] text-slate-500">{{ day.dateStr }}</span>
                                <span class="text-sm font-black" :class="idx===0 ? 'text-blue-600' : 'text-slate-700'">{{ day.dayName }}</span>
                                <span class="lunar-text">{{ day.lunarStr }}</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><i class="fas fa-clipboard-check text-slate-400 w-4"></i> 07:00 期初庫存</td>
                        <td v-for="(day, idx) in milkBankDays" :key="idx" 
                            @click="openInputModal('inventory', day)"
                            class="editable-cell relative" :class="{'bg-orange-50/30': day.isWeekend}">
                            <span :class="day.isManual.inventory ? 'text-indigo-600 font-bold' : 'text-slate-400 italic'">
                                {{ day.startStock.toFixed(1) }}
                            </span>
                            <div v-if="day.isManual.inventory" class="manual-dot"></div>
                        </td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-tint text-emerald-400 w-4"></i> 08:00 晨間收乳</td>
                        <td v-for="(day, idx) in milkBankDays" :key="idx" 
                            @click="openInputModal('harvestAM', day)"
                            class="editable-cell val-input relative" :class="{'bg-orange-50/30': day.isWeekend}">
                            +{{ day.harvestAM }}
                            <div v-if="day.isManual.harvestAM" class="manual-dot"></div>
                        </td>
                    </tr>
                    <tr class="bg-slate-50/50">
                        <td class="relative">
                            <i class="fas fa-truck text-red-400 w-4"></i> 09:00 訂單出貨
                        </td>
                        <td v-for="(day, idx) in milkBankDays" :key="idx" 
                            @click="openDetailModal(day)"
                            class="text-slate-500 font-medium text-xs cursor-pointer hover:bg-slate-100 transition relative">
                            -{{ day.demand.toFixed(2) }}
                            <i class="fas fa-search-plus text-[8px] absolute top-1 right-1 text-slate-300"></i>
                        </td>
                    </tr>
                    <tr v-for="n in 3" :key="`adhoc${n}`">
                        <td><i class="fas fa-box text-orange-400 w-4"></i> 14:00 團購出貨 {{n}}</td>
                        <td v-for="(day, idx) in milkBankDays" :key="idx" 
                            @click="openInputModal(`adhoc${n}`, day)"
                            class="editable-cell relative"
                            :class="[day[`adhoc${n}`] !== 0 ? 'val-adhoc font-bold' : 'text-slate-300', day.isWeekend ? 'bg-orange-50/30' : '']">
                            {{ day[`adhoc${n}`] }}
                            <div v-if="day.isManual[`adhoc${n}`]" class="manual-dot"></div>
                        </td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-moon text-blue-400 w-4"></i> 20:00 晚間收乳</td>
                        <td v-for="(day, idx) in milkBankDays" :key="idx" 
                            @click="openInputModal('harvestPM', day)"
                            class="editable-cell val-input relative" :class="{'bg-orange-50/30': day.isWeekend}">
                            +{{ day.harvestPM }}
                            <div v-if="day.isManual.harvestPM" class="manual-dot"></div>
                        </td>
                    </tr>
                    <tr class="h-12">
                        <td class="font-black text-slate-800 bg-slate-50 border-t border-slate-200">22:00 預估結餘</td>
                        <td v-for="(day, idx) in milkBankDays" :key="idx" 
                            class="val-balance text-sm border-t border-slate-200"
                            :class="{'val-negative': day.endStock < 0}">
                            {{ day.endStock.toFixed(2) }}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-slate-200 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pb-safe">
        <div class="flex justify-between items-center px-4 py-2">
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase">Quick Action</span>
                <span class="text-xs font-bold text-slate-800">快速記帳</span>
            </div>
            <div class="flex gap-3">
                <button @click="openQuickAction('inventory')" class="flex flex-col items-center justify-center w-12 h-10 bg-indigo-50 text-indigo-600 rounded-lg active:bg-indigo-100 transition">
                    <i class="fas fa-clipboard-check text-sm mb-0.5"></i><span class="text-[9px] font-bold">盤點</span>
                </button>
                <button @click="openQuickAction('harvestAM')" class="flex flex-col items-center justify-center w-12 h-10 bg-emerald-50 text-emerald-600 rounded-lg active:bg-emerald-100 transition">
                    <i class="fas fa-tint text-sm mb-0.5"></i><span class="text-[9px] font-bold">晨收</span>
                </button>
                <button @click="openQuickAction('harvestPM')" class="flex flex-col items-center justify-center w-12 h-10 bg-blue-50 text-blue-600 rounded-lg active:bg-blue-100 transition">
                    <i class="fas fa-moon text-sm mb-0.5"></i><span class="text-[9px] font-bold">晚收</span>
                </button>
                <button @click="openQuickAction('adhoc1')" class="flex flex-col items-center justify-center w-12 h-10 bg-orange-50 text-orange-600 rounded-lg active:bg-orange-100 transition">
                    <i class="fas fa-box text-sm mb-0.5"></i><span class="text-[9px] font-bold">團購</span>
                </button>
                <button @click="resetData" class="flex flex-col items-center justify-center w-10 h-10 text-slate-300 rounded-lg active:text-slate-500 transition">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
        </div>
        <div class="h-4 bg-white"></div>
    </div>

    <transition name="fade">
        <div v-if="inputModal.show" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
            <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm pointer-events-auto transition-opacity" @click="inputModal.show = false"></div>
            <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl relative p-6 pointer-events-auto transform transition-transform duration-300 pb-10">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-xl font-black text-slate-800">{{ inputModal.title }}</h3>
                        <p class="text-xs text-slate-400 font-bold mt-1">{{ inputModal.subtitle }}</p>
                    </div>
                    <div class="text-right">
                        <div class="bg-slate-100 px-3 py-1 rounded-lg text-xs font-bold text-slate-500 mb-1">{{ inputModal.dateLabel }}</div>
                        <div class="text-[10px] text-slate-400">{{ inputModal.lunarLabel }}</div>
                    </div>
                </div>
                <div class="flex items-center gap-4 mb-8">
                    <button @click="adjustValue(-1)" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-600 text-lg font-bold hover:bg-slate-200 active:scale-95 transition"><i class="fas fa-minus"></i></button>
                    <div class="flex-1 relative">
                        <input v-model.number="inputModal.value" type="number" class="w-full text-center text-4xl font-black text-slate-800 border-b-2 border-slate-200 py-2 focus:outline-none focus:border-blue-500 bg-transparent">
                        <span class="absolute right-2 bottom-4 text-slate-300 font-bold text-sm">kg</span>
                    </div>
                    <button @click="adjustValue(1)" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-600 text-lg font-bold hover:bg-slate-200 active:scale-95 transition"><i class="fas fa-plus"></i></button>
                </div>
                <button @click="confirmInput" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-[0.98] transition">確認更新</button>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="detailModal.show" class="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="detailModal.show = false"></div>
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl relative flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <div>
                        <h3 class="font-bold text-slate-800">{{ detailModal.dateStr }} 出貨明細</h3>
                        <p class="text-[10px] text-slate-400">系統自動解析 (隱藏0訂購量)</p>
                    </div>
                    <button @click="detailModal.show = false" class="w-8 h-8 rounded-full bg-white text-slate-400 flex items-center justify-center shadow-sm"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div v-for="item in detailModal.list" :key="item.id" class="flex justify-between items-center p-3 border rounded-xl" :class="item.isSpecial ? 'bg-indigo-50 border-indigo-100' : 'bg-white border-slate-100'">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-500 w-16 truncate">{{ item.name }}</span>
                            <span v-if="item.type === '大新'" class="px-1.5 py-0.5 bg-indigo-200 text-indigo-700 text-[9px] rounded font-bold">大新</span>
                            <span v-if="item.type === '金中'" class="px-1.5 py-0.5 bg-yellow-200 text-yellow-700 text-[9px] rounded font-bold">金中</span>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-slate-800 text-sm">{{ item.weight.toFixed(2) }} kg</div>
                            <div class="text-[9px] text-slate-400">{{ item.qty }} 瓶/份</div>
                        </div>
                    </div>
                    <div v-if="detailModal.list.length === 0" class="text-center py-8 text-slate-400">本日無配送需求</div>
                </div>
                <div class="p-3 bg-slate-50 border-t border-slate-100 text-right">
                    <span class="text-xs font-bold text-slate-500 mr-2">總計重量</span>
                    <span class="text-lg font-black text-red-500">{{ detailModal.total.toFixed(2) }} kg</span>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // --- 設定區 ---
    const CSV_LINK = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF9dZUNtfJjbPIf4_3wvrJoVIv7WxGrXKEit9V0ou25BA9L1lMCEjqykH41p3f2MZc2b02nMLJXnrw/pub?gid=216467280&single=true&output=csv';
    
    // Firebase 設定
    const firebaseConfig = {
        apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
        authDomain: "crm-ts-1225-001.firebaseapp.com",
        databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
        projectId: "crm-ts-1225-001",
        storageBucket: "crm-ts-1225-001.firebasestorage.app",
        messagingSenderId: "925760221722",
        appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
    };

    let db;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch (e) { console.error("Firebase init failed", e); }

    createApp({
        setup() {
            const rawRouteData = ref([]);
            const savedData = ref({}); 
            const firebaseConnected = ref(false);
            const inputModal = ref({ show: false, field: '', dateKey: '', value: 0, title: '', subtitle: '', dateLabel: '', lunarLabel: '' });
            const detailModal = ref({ show: false, list: [], total: 0, dateStr: '' });
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            
            // 預設值 (單位: kg)
            const defaults = { harvestAM: 13, harvestPM: 15 };

            // 1. Firebase Sync
            const initFirebase = () => {
                if(!db) return;
                const connectedRef = db.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    firebaseConnected.value = snap.val() === true;
                });

                // 監聽雲端 milk_bank_pro 節點
                db.ref('milk_bank_pro').on('value', (snap) => {
                    const val = snap.val();
                    if(val) savedData.value = val;
                });
            };

            const saveToCloud = () => {
                if(!db) return;
                db.ref('milk_bank_pro').set(savedData.value);
            };

            const resetData = () => {
                if(confirm('確定要清空所有雲端紀錄嗎？')) {
                    savedData.value = {};
                    saveToCloud();
                }
            };

            // 2. CSV & Parsing Logic
            const fetchSheet = () => {
                fetch(CSV_LINK).then(r=>r.text()).then(t => {
                    const lines = t.trim().split('\n');
                    const res = [];
                    for(let i=1; i<lines.length; i++) {
                        const row = lines[i].split(',');
                        if(row.length<3) continue;
                        const weekly = [];
                        for(let d=0; d<7; d++) {
                            const s = 3 + (d*5);
                            const sum = [0,1,2,3,4].reduce((acc, off) => {
                                const val = row[s+off] ? parseInt(row[s+off].toString().replace(/２/g,'2').trim()) || 0 : 0;
                                return acc + val;
                            }, 0);
                            weekly.push(sum);
                        }
                        res.push({ 
                            id: row[0].trim(), 
                            name: row[2].trim(),
                            weekly 
                        });
                    }
                    rawRouteData.value = res;
                });
            };

            // 權重解析引擎
            const getWeightConfig = (name) => {
                if (name.includes('大新')) return { weight: 0.95, type: '大新' };
                if (name.includes('金中')) return { weight: 0.50, type: '金中' };
                return { weight: 0.18, type: '一般' }; // 預設小瓶
            };

            // 3. 核心運算 (Today -> 2026/02/24)
            const milkBankDays = computed(() => {
                const days = [];
                const startDate = new Date(); 
                startDate.setHours(0,0,0,0);
                const endDate = new Date('2026-02-24');
                endDate.setHours(0,0,0,0);

                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                let runningStock = 0;

                for(let i=0; i<diffDays; i++) {
                    const dObj = new Date(startDate);
                    dObj.setDate(startDate.getDate() + i);
                    
                    const y = dObj.getFullYear();
                    const m = String(dObj.getMonth()+1).padStart(2,'0');
                    const d = String(dObj.getDate()).padStart(2,'0');
                    const dateKey = `${y}-${m}-${d}`;
                    const dayIdx = dObj.getDay();
                    const dayName = weekDays[dayIdx];
                    
                    let lunarStr = '';
                    try {
                        const lunar = Lunar.fromSolar(Solar.fromYmd(y, parseInt(m), parseInt(d)));
                        lunarStr = lunar.getMonthInChinese() + "月" + lunar.getDayInChinese();
                    } catch(e) { lunarStr = '-'; }

                    // --- Demand Logic (解析重量) ---
                    const sheetIdx = dayIdx === 0 ? 6 : dayIdx - 1;
                    let totalKg = 0;
                    
                    rawRouteData.value.forEach(row => {
                        const qty = row.weekly[sheetIdx];
                        if (qty > 0) { // 這裡已經在做基本的篩選，計算總量
                            const config = getWeightConfig(row.name);
                            totalKg += qty * config.weight;
                        }
                    });

                    // Retrieve Data
                    const dayData = savedData.value[dateKey] || {};
                    const harvestAM = dayData.harvestAM !== undefined ? dayData.harvestAM : defaults.harvestAM;
                    const harvestPM = dayData.harvestPM !== undefined ? dayData.harvestPM : defaults.harvestPM;
                    const adhoc1 = dayData.adhoc1 || 0;
                    const adhoc2 = dayData.adhoc2 || 0;
                    const adhoc3 = dayData.adhoc3 || 0;

                    let startStock = runningStock;
                    if(dayData.inventory !== undefined) {
                        startStock = dayData.inventory;
                    } else if (i === 0 && dayData.inventory === undefined) {
                        startStock = 10; 
                    }

                    const endStock = startStock + harvestAM + harvestPM - totalKg + adhoc1 + adhoc2 + adhoc3;
                    runningStock = endStock;

                    days.push({
                        dateKey, dateStr: `${m}/${d}`, dayName, lunarStr,
                        isWeekend: dayIdx === 0 || dayIdx === 6,
                        sheetIdx, // 用於明細查詢
                        startStock, harvestAM, harvestPM,
                        adhoc1, adhoc2, adhoc3,
                        demand: totalKg,
                        endStock,
                        isManual: {
                            inventory: dayData.inventory !== undefined,
                            harvestAM: dayData.harvestAM !== undefined,
                            harvestPM: dayData.harvestPM !== undefined,
                            adhoc1: dayData.adhoc1 !== undefined && dayData.adhoc1 !== 0,
                        }
                    });
                }
                return days;
            });

            const todayEndStock = computed(() => milkBankDays.value[0]?.endStock || 0);
            
            // 4. Input Logic
            const openInputModal = (field, day) => {
                inputModal.value.field = field;
                inputModal.value.dateKey = day.dateKey;
                inputModal.value.show = true;
                inputModal.value.dateLabel = `${day.dateStr} ${day.dayName}`;
                inputModal.value.lunarLabel = `農曆 ${day.lunarStr}`;

                if(field === 'inventory') {
                    inputModal.value.title = '期初盤點';
                    inputModal.value.subtitle = '07:00 實際庫存';
                    inputModal.value.value = day.startStock;
                } else if(field === 'harvestAM') {
                    inputModal.value.title = '晨間收乳';
                    inputModal.value.subtitle = '08:00 實際產出';
                    inputModal.value.value = day.harvestAM;
                } else if(field === 'harvestPM') {
                    inputModal.value.title = '晚間收乳';
                    inputModal.value.subtitle = '20:00 實際產出';
                    inputModal.value.value = day.harvestPM;
                } else if(field.startsWith('adhoc')) {
                    const num = field.replace('adhoc', '');
                    inputModal.value.title = `團購出貨 ${num}`;
                    inputModal.value.subtitle = '請輸入負數 (例如 -5)';
                    inputModal.value.value = day[field];
                }
            };

            const openQuickAction = (field) => {
                if(milkBankDays.value.length > 0) openInputModal(field, milkBankDays.value[0]);
            };

            const adjustValue = (delta) => inputModal.value.value = parseFloat((inputModal.value + delta).toFixed(2));

            const confirmInput = () => {
                const { dateKey, field, value } = inputModal.value;
                if(!savedData.value[dateKey]) savedData.value[dateKey] = {};
                savedData.value[dateKey][field] = value;
                saveToCloud();
                inputModal.value.show = false;
            };

            // 5. Detail Logic (解析明細)
            const openDetailModal = (day) => {
                const list = [];
                let total = 0;
                
                rawRouteData.value.forEach(row => {
                    const qty = row.weekly[day.sheetIdx];
                    // 這裡執行過濾：如果 qty 為 0，不顯示
                    if (qty > 0) {
                        const config = getWeightConfig(row.name);
                        const weight = qty * config.weight;
                        list.push({
                            id: row.id,
                            name: row.name,
                            qty: qty,
                            type: config.type,
                            weight: weight,
                            isSpecial: config.type !== '一般'
                        });
                        total += weight;
                    }
                });

                detailModal.value = {
                    show: true,
                    dateStr: `${day.dateStr} ${day.dayName}`,
                    list: list,
                    total: total
                };
            };

            onMounted(() => {
                initFirebase();
                fetchSheet();
            });

            return {
                firebaseConnected, milkBankDays, todayEndStock,
                inputModal, detailModal,
                openInputModal, openQuickAction, adjustValue, confirmInput, resetData, openDetailModal
            };
        }
    }).mount('#app');
</script>
</body>
</html>
